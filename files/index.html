<!-- files/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Victron AES Key Config</title>
  <link rel="icon" href="/favicon.ico"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <div class="wobble-bg"></div>
  <!-- 3D Cube + Particles -->
  <div class="cube-container">
    <div class="particles"></div>
    <div class="cube">
      <div class="face back"></div>
      <div class="face right"></div>
      <div class="face left"></div>
      <div class="face top"></div>
      <div class="face bottom"></div>
    </div>
  </div>
  <div class="center-content">
    <h1>Victron AES Key Configuration</h1>
    <!-- AES Key Form -->
    <form id="keyForm">
      <label for="key">Enter 16-byte AES Key (32 hex chars):</label><br/>
      <input type="text"
             id="key"
             name="key"
             minlength="32"
             maxlength="32"
             placeholder="4B7178E64C828A262CDD5161E3404B7A"
             required/><br/>
      <button type="submit">Save Key</button>
    </form>
    <div id="response"></div>
  </div>
  <!-- jQuery -->
  <script src="/js/jquery-3.7.1.js"></script>
  <!-- Form submit + trigger animations -->
  <script>
    $('#keyForm').on('submit', function(e) {
        e.preventDefault();
        var form = this;
        $.post('/save', $(form).serialize())
          .done(function() { $('#response').text('Saved! Rebootingâ€¦'); })
          .fail(function() { $('#response').text('Error saving key.'); });
        triggerExplosion(form.querySelector('button'));
        setTimeout(triggerSpiralParticleCollect, 4000);
    });
  </script>
  <!-- 3D cube & particle scripts -->
  <script>
function triggerSpiralParticleCollect() {
    const particleCount = 30;
    const particlesContainer = document.querySelector('.particles');
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle', 'spiral-collect');
        const radius = Math.random() * 200;
        const angle = Math.random() * Math.PI * 2;
        const startX = (Math.cos(angle) * radius) + 'px';
        const startY = (Math.sin(angle) * radius) + 'px';
        const startZ = (Math.random() * 200 - 100) + 'px';
        particle.style.setProperty('--startX', startX);
        particle.style.setProperty('--startY', startY);
        particle.style.setProperty('--startZ', startZ);
        particle.style.setProperty('--endX', '0px');
        particle.style.setProperty('--endY', '0px');
        particle.style.setProperty('--endZ', '0px');
        const duration = (Math.random() * 3 + 1) + 's';
        const delay = (Math.random() * 2) + 's';
        particle.style.animationDuration = duration;
        particle.style.animationDelay = delay;
        particlesContainer.appendChild(particle);
        setTimeout(() => { particle.remove(); }, parseFloat(duration) * 1000 + 2000);
    }
}

function triggerExplosion(element) {
    const particleCount = 50;
    const particlesContainer = document.querySelector('.particles');
    const rect = element.getBoundingClientRect();
    const containerRect = particlesContainer.getBoundingClientRect();
    const centerX = (rect.left + rect.width / 2) - containerRect.left;
    const centerY = (rect.top + rect.height / 2) - containerRect.top;
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const endX = (Math.random() * 400 - 200) + 'px';
        const endY = (Math.random() * 400 - 200) + 'px';
        const endZ = (Math.random() * 400 - 200) + 'px';
        particle.style.setProperty('--startX', `${centerX}px`);
        particle.style.setProperty('--startY', `${centerY}px`);
        particle.style.setProperty('--startZ', '0px');
        particle.style.setProperty('--endX', endX);
        particle.style.setProperty('--endY', endY);
        particle.style.setProperty('--endZ', endZ);
        const duration = (Math.random() * 2 + 0.5) + 's';
        particle.style.animationDuration = duration;
        particle.style.animationDelay = '0s';
        particlesContainer.appendChild(particle);
        setTimeout(() => { particle.remove(); }, parseFloat(duration) * 1000);
    }
}

// Initial floating particles
document.addEventListener("DOMContentLoaded", function() {
    const particleCount = 20;
    const particlesContainer = document.querySelector('.particles');
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const startX = (Math.random() * 200 - 100) + 'px';
        const startY = (Math.random() * 200 - 100) + 'px';
        const startZ = (Math.random() * 200 - 100) + 'px';
        const endX = (Math.random() * 200 - 100) + 'px';
        const endY = (Math.random() * 200 - 100) + 'px';
        const endZ = (Math.random() * 200 - 100) + 'px';
        particle.style.setProperty('--startX', startX);
        particle.style.setProperty('--startY', startY);
        particle.style.setProperty('--startZ', startZ);
        particle.style.setProperty('--endX', endX);
        particle.style.setProperty('--endY', endY);
        particle.style.setProperty('--endZ', endZ);
        const duration = (Math.random() * 5 + 5) + 's';
        const delay = (Math.random() * 5) + 's';
        particle.style.animationDuration = duration;
        particle.style.animationDelay = delay;
        particlesContainer.appendChild(particle);
    }
});

// Trigger explosion at click position anywhere on the page
document.addEventListener('click', function(e) {
    const particlesContainer = document.querySelector('.particles');
    const particleCount = 50;
    // Get click position relative to the particles container
    const containerRect = particlesContainer.getBoundingClientRect();
    const centerX = e.clientX - containerRect.left;
    const centerY = e.clientY - containerRect.top;
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const endX = (Math.random() * 400 - 200) + 'px';
        const endY = (Math.random() * 400 - 200) + 'px';
        const endZ = (Math.random() * 400 - 200) + 'px';
        particle.style.setProperty('--startX', `${centerX}px`);
        particle.style.setProperty('--startY', `${centerY}px`);
        particle.style.setProperty('--startZ', '0px');
        particle.style.setProperty('--endX', endX);
        particle.style.setProperty('--endY', endY);
        particle.style.setProperty('--endZ', endZ);
        const duration = (Math.random() * 2 + 0.5) + 's';
        particle.style.animationDuration = duration;
        particle.style.animationDelay = '0s';
        particlesContainer.appendChild(particle);
        setTimeout(() => { particle.remove(); }, parseFloat(duration) * 1000);
    }
});
  </script>
</body>
</html>
